/*
 * File: app/view/Map.js
 *
 * This file was generated by Sencha Architect version 2.0.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Sencha Touch 2.0.x library, under independent license.
 * License of Sencha Architect does not include license for Sencha Touch 2.0.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('Cheers.view.Map', {
    extend: 'Ext.Map',
    alias: 'widget.map',

    config: {
		//useCurrentLocation: true,
        listeners: [
            {
                fn: 'onMapMaprender',
                event: 'maprender'
            }
        ]
    },

    onMapMaprender: function(map, gmap, options) {
	
    //return false;
        //var store = Ext.getStore('Deals');
        //var count = store.getCount();
        //debugger;
        
       
     

       var store = Ext.create('Ext.data.Store', {
           model: 'Cheers.model.Deal',
           proxy: {
                   type: 'ajax',
                   url :API_URL +'?id='+ USER_ID + '&lat='+ LAT +'&lon='+ LON + '&action=deals&rand='+ Math.random(),	
                   reader : {
                                     type : 'json',
                                     rootProperty: ''
                           }
           }
           });
          // alert('store loaded');
          store.load({
       scope: this,
       callback: function(records) {
           //debugger;
                           //console.log(records);
                           //alert('shit');
           this.processMap(records);
           }
       });
		
        
        /*
        var neighborhoods = [
        new google.maps.LatLng(52.511467, 13.447179),
        new google.maps.LatLng(52.549061, 13.422975),
        new google.maps.LatLng(52.497622, 13.396110),
        new google.maps.LatLng(52.517683, 13.394393)
        ];


        for (var i = 0; i < neighborhoods.length; i++) {
        var m = neighborhoods[i];

        new google.maps.Marker({
        position: m,
        map: gmap,
        draggable: false,
        animation: google.maps.Animation.DROP
        });
        }*/
    },

    processMap: function(bp) {
		 
        console.log("hay "+bp.length+" elementos");
        for (var i = 0, ln = bp.length; i < ln; i++) {
            var bpItem = bp[i].data;
            console.log('bp item=');
            console.log(bpItem);
			//alert(tweet.geo.coordinates);
            //if (tweet.geo && tweet.geo.coordinates) {
                this.addMarker(bpItem);
                console.log("coordenadas? "+i);
           // }
        }
    },

    addMarker: function(bp) {

		console.log('weeee='+bp.lat);
        var infoWindow = new google.maps.InfoWindow(),
        point = new google.maps.LatLng(
        bp.lat,
        bp.lon
        ),
        marker = new google.maps.Marker({
            map: this.getMap(),
            position: point
        });

        google.maps.event.addListener(marker, "click", function() {
            infoWindow.setContent(bp.bp_name);
            infoWindow.open(this.getMap(), marker);
        });
    }

});